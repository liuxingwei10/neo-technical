=ONLY FOR AMD64 BUILDS=

==RadeonHD 7000 series support for Gentoo==

This guide is overly specific and should only be used by those who either know what you're doing, or I told you to follow this page. This is *_NOT_* intended as the ultimate guide for anybody who wants RadeonHD 7000 series support for their Gentoo install, rather my friends.

===Updating the toolchain with Graphite loop optimization and LTO===

*This all must be done as superuser / root!*

1.) Modify /etc/portage/make.conf via vim or nano (emerge -av vim) and replace the entire file with this:

{{{
CFLAGS="-march=core2 -O2 -pipe -fomit-frame-pointer"
CXXFLAGS="${CFLAGS}"

CHOST="x86_64-pc-linux-gnu"

USE="mmx sse sse2 sse3 graphite lto gmp cxx pic nls nptl threads zlib udev device-mapper python sasl gnutls ssl openssl crypt gcrypt cracklib mhash pam expat guile bash-completion-r1 readline ncurses"

MAKEOPTS="-j5"

GENTOO_MIRRORS="http://mirrors.rit.edu/gentoo/"

SYNC="rsync://rsync29.us.gentoo.org/gentoo-portage"
}}}

2.) Sync portage:

{{{
emerge --sync
}}}

3.) Update your system:

{{{
emerge --with-bdeps=y --update --verbose --deep --newuse --ask @world
}}}

After your system has been fully updated, we will need to unmask newer versions of several Xorg and X11 libraries.

4.) Unmask everything we will eventually need, right now. Open up your favorite command line text editor and modify the following file:

/etc/portage/package.accept_keywords

and replace all contents with this:

{{{
# kernel
sys-kernel/git-sources
# zlib
sys-libs/zlib **
# gcc
=sys-devel/gcc-4.6.3 **
sys-devel/gcc-config
# udev and init
sys-fs/udev
sys-apps/openrc
sys-fs/udev-init-scripts
sys-apps/kmod
# udev deps
net-wireless/bluez
sys-fs/udisks
# pci and usbutils
=sys-apps/hwids-99999999 **
sys-apps/usbutils
sys-apps/pciutils
sys-libs/mtdev
# lvm2
sys-fs/lvm2
sys-block/thin-provisioning-tools
# LLVM
sys-devel/llvm
# Xorg
x11-base/xorg-server
x11-base/xorg-drivers
x11-libs/libpciaccess
x11-libs/libdrm **
x11-libs/libxcb
x11-libs/libXvMC
x11-proto/inputproto
x11-proto/xcb-proto
x11-proto/glproto
x11-proto/dri2proto
x11-proto/randrproto
x11-drivers/radeon-ucode
x11-drivers/xf86-video-vesa
x11-drivers/xf86-video-fbdev
x11-drivers/xf86-video-ati
x11-drivers/xf86-input-evdev
x11-drivers/xf86-input-mouse
x11-drivers/xf86-input-keyboard
app-admin/eselect-opengl
x11-apps/mesa-progs
virtual/glu
media-libs/glu
media-libs/mesa **
# 32-bit libs
app-emulation/emul-linux-x86-qtlibs
app-emulation/emul-linux-x86-baselibs
app-emulation/emul-linux-x86-xlibs
app-emulation/emul-linux-x86-medialibs
app-emulation/emul-linux-x86-opengl
app-emulation/emul-linux-x86-soundlibs
app-emulation/emul-linux-x86-db
# Various other things
media-libs/libexif
gnome-base/librsvg
dev-libs/gobject-introspection-common
dev-libs/gobject-introspection
media-libs/babl
media-libs/gegl
dev-libs/glib
dev-lang/vala
dev-libs/vala-common

# GNOME 3
app-accessibility/at-spi2-core
app-accessibility/caribou
app-arch/file-roller
app-cdr/brasero
app-crypt/p11-kit
app-crypt/seahorse
app-editors/gedit
app-misc/tracker
app-text/evince
app-text/yelp-tools
dev-cpp/glibmm
dev-cpp/gtkmm
dev-lang/spidermonkey
dev-libs/atk
dev-libs/folks
dev-libs/gjs
dev-libs/libgdata
dev-libs/libgweather
dev-libs/libpeas
dev-python/pyatspi
dev-util/gtk-builder-convert
games-board/aisleriot
gnome-base/gdm
gnome-base/gnome
gnome-base/gnome-light
gnome-base/gnome-applets
gnome-base/gnome-control-center
gnome-base/gnome-core-apps
gnome-base/gnome-core-libs
gnome-base/gnome-desktop
gnome-base/gnome-extra-apps
gnome-base/gnome-fallback
gnome-base/gnome-keyring
gnome-base/gnome-menus
gnome-base/gnome-panel
gnome-base/gnome-session
gnome-base/gnome-settings-daemon
gnome-base/gnome-shell
gnome-base/gsettings-desktop-schemas
gnome-base/libgnomekbd
gnome-base/libgnome-keyring
gnome-base/nautilus
gnome-extra/evolution-data-server
gnome-extra/gcalctool
gnome-extra/gconf-editor
gnome-extra/gnome-contacts
gnome-extra/gnome-documents
gnome-extra/gnome-games
gnome-extra/gnome-power-manager
gnome-extra/gnome-screensaver
gnome-extra/gnome-system-monitor
gnome-extra/gnome-tweak-tool
gnome-extra/gnome-user-docs
gnome-extra/gnome-utils
gnome-extra/gtkhtml
gnome-extra/gucharmap
gnome-extra/nautilus-tracker-tags
gnome-extra/nm-applet
gnome-extra/sushi
gnome-extra/yelp
gnome-extra/yelp-xsl
mail-client/evolution
media-gfx/eog
media-gfx/shotwell
media-libs/clutter
media-libs/cogl
media-libs/gexiv2
media-libs/libchamplain
media-libs/libgnome-media-profiles
media-libs/libraw
media-sound/sound-juicer
media-video/cheese
media-video/totem
net-analyzer/gnome-nettool
net-im/empathy
net-im/telepathy-logger
net-libs/gnome-online-accounts
net-libs/liboauth
net-libs/libsocialweb
net-libs/libsoup-gnome
net-libs/libsoup
net-libs/telepathy-glib
net-libs/webkit-gtk
net-misc/networkmanager
net-misc/vinagre
net-misc/vino
net-print/cups-pk-helper
net-wireless/gnome-bluetooth
sys-apps/accountsservice
www-client/epiphany
x11-libs/gdk-pixbuf
x11-libs/gtk+
x11-libs/gtksourceview
x11-libs/libwnck
x11-libs/mx
x11-libs/pango
x11-libs/vte
x11-misc/notification-daemon
x11-terms/gnome-terminal
x11-themes/gnome-backgrounds
x11-themes/gnome-icon-theme-symbolic
x11-themes/gnome-themes-standard
x11-wm/metacity
x11-wm/mutter
}}}

Please note that we are using kernel sources from the latest git tree but this is required for RadeonSI (Southern Islands / 7000 series) hardware. When kernel 3.7 is released and hits the gentoo tree, you may replace git-sources with vanilla-sources or gentoo-sources however vanilla-sources is generally updated sooner and more often than gentoo-sources.

5.) It is time to update your system yet again:

{{{
emerge --with-bdeps=y -uvDNa @world
}}}

After a massive system rebuild, you'll need to do a few more things before proceeding. Run these commands separately and in order, one after another.

{{{
etc-update
env-update
source /etc/profile
}}}

If etc-update has new config updates, use the "-3" option and modify those newly updated config files again to your liking via text editor.

6.) Now that your version of GCC (4.6.3) supports your real CPU, you can now modify your make.conf file for further optimization. This change will boost performance in Mesa and other packages as well due to support for SSE4.X and further CPU optimizations. To make this quick and easy, we will use sed.

{{{
sed -i 's/-march=core2/-march=corei7/g' /etc/portage/make.conf
}}}

7.) Rebuild your system against your new CFLAGS and compiler to ensure system stability and reliability.

{{{
emerge -eND @world
}}}

Now that the world has ended, it is time to finish it up before doing anything else.

{{{
hash -r
etc-update
env-update
source /etc/profile
}}}

8.) Ensure that the radeon microcode is installed:

(A UAV is online! Enemy UAV is airborne!)

{{{
emerge -uav radeon-ucode
}}}

9.) Add process accounting to start-up:

{{{
emerge acct
rc-update add acct boot
}}}

10.) Download, install, and configure the kernel

{{{
emerge git-sources
eselect kernel list
}}}

Select the linux-3.7-rcX kernel

{{{
eselect kernel set <number>
}}}


Enter the kernel source directory, load the config, compile, and install.

{{{
cd /usr/src/linux
wget http://neo-technical.googlecode.com/svn/kernel_rc1.config
make oldconfig
make -j5
make modules_install
rm -rf /boot/vmlinuz*
rm -rf /boot/config*
cp -prvL arch/x86/boot/bzImage /boot/vmlinuz-26
cp -prvL System.map /boot/System.map
ln -sfv /boot/System.map /boot/System.map-3.7-rc1
cp -prvL .config /boot/config
ln -sfv /boot/config /boot/config-3.7-rc1
}}}

Just be sure to replace /dev/sdb1 with whatever partition and drive you have Gentoo on.

11.) Reboot your system

{{{
shutdown -r now
}}}

When your system comes back up, you must modify your profile as root.

12.) Update your profile:

{{{
eselect profile list
}}}

{{{
eselect profile set <number of GNOME profile>
}}}

13.) Modify /etc/portage/make.conf again and add in your devices, video cards, and additional USE flags. For a full-on and fully-blown example of a good set of USE flags along with a practically complete make.conf file:

{{{
CFLAGS="-march=corei7 -O2 -pipe -fomit-frame-pointer"
CXXFLAGS="${CFLAGS}"

CHOST="x86_64-pc-linux-gnu"

USE="mmx sse sse2 sse3 graphite lto gmp cxx pic nls nptl threads zlib udev device-mapper gpm dbus libnotify inotify python tcl tk policykit sasl gnutls ssl openssl crypt gcrypt cracklib mhash pam X multimedia Xaw3d fbcon smp truetype fontconfig gnome gnome-keyring mime cairo gd gdbm qt3support gtk dri expat guile bash-completion-r1 readline ncurses aspell alsa openal aalib libcaca oss pulseaudio xcomposite xcb xv xa libkms g3dvl vaapi vdpau r600-llvm-compiler gles2 openvg x264 ffmpeg xvmc dga svga theora soprano lame lzo svg gif png xml exif flac tiff mad mplayer dvd dvdr cdr cdparanoia ogg vorbis gstreamer sdl sound a52 dts sndfile libsamplerate faac aac ao glut opengl vala"

MAKEOPTS="-j4"

# r600 is set just to be safe for mesa
VIDEO_CARDS="radeon r600 radeonsi fbdev vesa"

INPUT_DEVICES="evdev mouse keyboard"

GENTOO_MIRRORS="http://mirrors.rit.edu/gentoo/"

SYNC="rsync://rsync29.us.gentoo.org/gentoo-portage"
}}}

14.) Get GNOME and X working:

{{{
emerge --with-bdeps=y -uvDNa @world
emerge -av consolekit gnome gdm
}}}

If you have any messages that show up that say, "The following USE changes are necessary to proceed..." then add --autounmask-write to the emerge line, for example:

{{{
emerge --autounmask-write --with-bdeps=y -uvDNa @world
}}}

or

{{{
emerge -av --autounmask-write gnome gdm
}}}

Then run

{{{
etc-update
}}}

with the -3 option.

15.) Make gdm the default login manager:

Please note that vim is the best command line editor and should be used whenever possible (hehe...)

{{{
vim /etc/conf.d/xdm
}}}

Replace DISPLAYMANAGER="xdm" with DISPLAYMANAGER="gdm" within the file.

16.) Add dbus, consolekit, and to your start-up scripts:

{{{
rc-update add dbus default
rc-update add consolekit default
rc-update add gdm default
}}}

17.) Verify all config files and library paths are up-to-date:

Use -3 as the option for pretty much every time you use etc-update and you have updates awaiting. This will make sure the files get updated and modified correctly.

{{{
etc-update
env-update
source /etc/profile
}}}

18.) Make a NORMAL user if you haven't already:

{{{
useradd -m -G users,audio,video,power,wheel -s /bin/bash <your username>
passwd <your username>
<enter password>
<enter password to verify>
<might have to enter it again if it's a dictionary word>
}}}

19.) Reboot:

{{{
shutdown -r now
}}}

20.) Log in to GNOME via GDM, and open up a GNOME terminal and make sure your video card is working properly:

{{{
glxinfo
}}}

OpenGL renderer string should now be AMD something rather.